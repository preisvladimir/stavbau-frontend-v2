# üóÇ hotovo-todo-future.md

## ‚úÖ HOTOVO

### 8. 9. 2025 --- Inicializace projektu

-   **Maven projekt** (Java 17, Spring Boot 3.2.x) + z√°kladn√≠ `pom.xml`
    (web, security, validation, data-jpa, Flyway, PostgreSQL, MapStruct,
    OpenAPI).\
-   **Kostra aplikace**: `StavbauBackendApplication`, `application.yml`
    (datasource, Flyway, JWT dev secret).\
-   **i18n z√°klad**: `MessageSourceConfig` (`messages_cs/en`),
    `AcceptHeaderLocaleResolver` (default cs).
    -   `PingController` + n√°vrat hlaviƒçky `Content-Language`.\
-   **Bezpeƒçnost & infrastruktura**:
    -   `SecurityConfig`: stateless, CSRF off, povoleno `/actuator/**`,
        `/v3/api-docs/**`, `/swagger-ui/**`, `/api/v1/auth/**`,
        `/api/v1/ping`.\
    -   `ApiExceptionHandler` (RFC7807 styl).\
    -   `BaseEntity` + auditing (`JpaAuditingConfig`).\
-   **Datab√°ze (Docker) & migrace**:
    -   Postgres 16 (Docker), s√≠≈• + volume, p≈ôedinstalace `uuid-ossp`.\
    -   Flyway:
        -   V1: `companies`, `users` (z√°klad, locale, company_id).\
        -   V2: `users` roz≈°√≠≈ôeno o `token_version` a `refresh_token_id`
            (refresh rotace).\
-   **Oprava z√°vislost√≠**: odstranƒõny konfliktn√≠ Hypersistence Utils
    (Hibernate 6.4).
    -   ponech√°na `hibernate-types-60` (JSONB apod.).\
-   **JWT autentizace (header) + refresh v HttpOnly cookie**
    -   `PasswordEncoder` (BCrypt, cost=12).\
    -   `JwtService`: vyd√°v√°n√≠ access (kr√°tk√° TTL) + refresh (aud
        ‚Äûrefresh", jti, ver).\
    -   `RefreshCookie`: HttpOnly, SameSite=Lax, path ‚Äû/".\
    -   `JwtAuthenticationFilter`: naƒç√≠t√° Bearer token ‚Üí
        `UsernamePasswordAuthenticationToken`.\
    -   `AppUserPrincipal`: zmƒõnƒõn na POJO (fix 500 na `/auth/me`).\
-   **AuthController**:
    -   `POST /auth/login` ‚Üí access v tƒõle + refresh cookie (rotace
        jti).\
    -   `POST /auth/refresh` ‚Üí validace cookie (aud/ver/jti), rotace +
        reuse detekce.\
    -   `POST /auth/logout` ‚Üí sma≈æe cookie + zneplatn√≠ jti.\
    -   `GET /auth/me` ‚Üí vrac√≠ `userId`, `companyId`, `email`.\
-   **Entity & repo**:
    -   `User` bez Lomboku (ruƒçn√≠ gettery/settery).\
    -   `Company` + obƒõ repository (`UserRepository`,
        `CompanyRepository`).\
-   **Dev seeding**:
    -   `DevUserSeeder` (profil dev\|default): firma + admin
        `admin@stavbau.local` / `admin123`.\
-   **Testy (PowerShell)**:
    -   `/api/v1/ping` (200, Content-Language).\
    -   `/auth/login` ‚Üí z√≠sk√°n√≠ access tokenu + refresh cookie.\
    -   `/auth/me` s Bearer.\
    -   `/auth/refresh` (nov√Ω access, cookie rotace).\
    -   `/auth/logout` (204).\
-   **Rate limiting (p≈ô√≠prava)**:
    -   pou≈æit√≠ Bucket4j 7.6.0.\
    -   `RateLimitFilter` (per-IP, nap≈ô. 10/min + 3/10s).\
    -   `SecurityConfig`: ≈ôetƒõzen√≠ filtr≈Ø (rate-limit ‚Üí JWT ‚Üí
        UsernamePasswordAuthenticationFilter).
-   **GitHub repozit√°≈ôe** zalo≈æeny:
    - Backend: `https://github.com/preisvladimir/stavbau-backend-v2`
    - Frontend: `https://github.com/preisvladimir/stavbau-frontend-v2`
-   **Backend ‚Äì prvn√≠ commit**: p≈ôid√°ny dokumenty (`/docs`), `README.md`, `CHANGELOG.md`, `.gitignore`, z√°kladn√≠ BE skeleton (Spring Boot), Flyway migrace, i18n, security, JWT, rate-limit filtr (p≈ô√≠prava).
- **Oprava remote**: backend byl omylem napojen na `frontend-v2`; remote opraven a obsah p≈ôesunut do spr√°vn√©ho repozit√°≈ôe.
- **CI (backend)**: p≈ôid√°n workflow `backend-ci.yml` (Java 17 + Maven) a pushnut do `main`.
- **Repo metainfra ‚Äì n√°vrh**: p≈ôipraveny `.gitattributes` (LF default) a `.editorconfig` (konzistentn√≠ form√°t); doporuƒçeno commitnout.
- **Pokyny a ≈°ablony**: `STAVBAU_GUIDELINES.md`, `STAVBAU_TEMPLATES.md`, `POKYNY_GITHUB.md` a workflow ≈°ablony p≈ôipraveny.

### 9. 9. 2025 --- Pl√°nov√°n√≠ RBAC BE (MVP)

- **üïí Miln√≠k (pl√°nov√°n√≠):** RBAC BE (MVP) ‚Äì Step Plan schv√°len.
- **TODO (Sprint 2):**
    - Implementovat `security/rbac` (Scopes, CompanyRoleName, ProjectRoleName, BuiltInRoles).
    - `RbacService` + `RbacServiceImpl`, `RbacMethodSecurityConfig`.
    - √öpravy `AppUserPrincipal` a `JwtService` ‚Äì claims: `companyRole`, `projectRoles[]`, `scopes[]`.
    - `/auth/me` roz≈°√≠≈ôit o `companyRole`, `scopes[]`.
    - Anotace pilotn√≠ch endpoint≈Ø (`projects:read`, `projects:create`).
    - Doplnit i18n kl√≠ƒçe pro 401/403 (auth.forbidden_missing_scope).
    - Testy: unit (`BuiltInRolesTest`, `RbacServiceTest`), slice (`WebMvcTest` 401/403/200), integraƒçn√≠ happy path.
- **FUTURE:**
    - Projektov√© role + `hasProjectScope` enforcement (Sprint 3).
    - DB perzistence rol√≠/scopes (PRO f√°ze).
    - Admin UI pro spr√°vu rol√≠.

### 9. 9. 2025 ‚Äî RBAC z√°klad + JWT filtry (BE)

**HOTOVO**
- P≈ôid√°n skeleton RBAC modulu (`security/rbac`): `Scopes`, `CompanyRoleName`, `ProjectRoleName`, `ProjectRoleAssignment`, `BuiltInRoles` (pr√°zdn√© mapy pro MVP), `RbacService` + `RbacSpelEvaluator`, `RbacMethodSecurityConfig`. :contentReference[oaicite:0]{index=0}
- `JwtService` roz≈°√≠≈ôen o RBAC claims (`companyRole`, `projectRoles[]`, `scopes[]`) + helpery `extract*`. :contentReference[oaicite:1]{index=1}
- `JwtAuthenticationFilter` refaktor: mapuje JWT ‚Üí `AppUserPrincipal`; generuje `ROLE_*` a `SCOPE_*` authorities. :contentReference[oaicite:2]{index=2}
- `SecurityConfig` opraveno po≈ôad√≠ filtr≈Ø: **RateLimit ‚Üí JWT ‚Üí UsernamePasswordAuthenticationFilter** (oba ankory p≈ôed vestavƒõn√Ω filtr).
- Aplikace startuje, autentizace bƒõ≈æ√≠ (login/refresh), z√°klad pro `@PreAuthorize("@rbac‚Ä¶")` p≈ôipraven. :contentReference[oaicite:3]{index=3}

**TODO (Sprint 2)**
- Naplnit `BuiltInRoles.companyRoleScopes` podle RBAC_2.1 (OWNER, COMPANY_ADMIN, ‚Ä¶). :contentReference[oaicite:4]{index=4}
- `/auth/me` roz≈°√≠≈ôit o `companyRole`, `projectRoles[]`, `scopes[]`; FE toggly budou ƒçerpat z API. :contentReference[oaicite:5]{index=5}
- Anotovat pilotn√≠ endpointy: `projects:read`, `projects:create` p≈ôes `@PreAuthorize("@rbac.hasScope('‚Ä¶')")`. :contentReference[oaicite:6]{index=6}
- Testy: unit (`BuiltInRolesTest`, `RbacServiceImplTest`), slice (`@WebMvcTest` 401/403/200), integraƒçn√≠ happy-path login ‚Üí chr√°nƒõn√Ω endpoint. :contentReference[oaicite:7]{index=7}
- i18n: doplnit kl√≠ƒçe pro 401/403 (`auth.forbidden_missing_scope`, ‚Ä¶).

**FUTURE**
- Project role enforcement (`hasProjectScope`, `canReadProject`) + membership check (Sprint 3). :contentReference[oaicite:8]{index=8}
- PRO f√°ze: RBAC v DB + admin UI, cache & invalidace. :contentReference[oaicite:9]{index=9}

## HOTOVO ‚Äì 2025-09-10
- DB init p≈ôes Flyway: companies, company_nace, users (V2025_09_10_000)
- Dopl≈àkov√© migrace: registered_address radek_adresy1/2 (V2025_09_10_001)
- Sjednocen√≠ n√°zv≈Ø: tabulka `companies`, FK users.company_id ‚Üí companies(id)
- MapStruct: vypnut√Ω builder, ignorace auditn√≠ch pol√≠, AresCompanyMapper + CompanyMapper OK
- ARES integrace: DTO (AresSubjectDto), mapper, service skeleton, WebFlux v pom.xml
- AresCompanyMapper ‚Äì sjednoceny ignore mapping pro single i legacy tvary payloadu.
- RegistrationStatuses: doƒçasnƒõ @Transient

## TODO (dal≈°√≠ sprint)
- AresClient+Service testy (MockWebServer), AresCompanyMapper testy
- Endpoint POST /api/companies/import/ares ‚Üí persist & upsert
- Security pravidla pro `/api/companies/lookup/**`
- (Rozhodnout) Persist `RegistrationStatuses` ‚Äì sloupce nebo JSONB snapshot

## FUTURE
- Validace IƒåO mod 11 (BE), FE hinty dle ARES
- Indexy pro vyhled√°v√°n√≠: ico, okres_nuts_lau, dor_obec/psc (pokud bude pot≈ôeba)

### 11. 9. 2025 ‚Äî Anal√Ωza & pl√°n integrace GEO (Mapy.cz API)

**HOTOVO (anal√Ωza & pl√°n):**
- Provedena anal√Ωza bal√≠ƒçku **geo.zip** z verze 1.
- Navr≈æen **Step Plan** pro migraci do STAVBAU-V2: modular-by-feature, bezpeƒçn√° konfigurace (API key v ENV), caching (Caffeine), testy (unit + integraƒçn√≠), FE hook (debounce input).

**TODO (implementace):**
- Vytvo≈ôit bal√≠ƒçek `cz.stavbau.backend.geo` se strukturou `config/`, `service/`, `controller/`, `dto/`.
- P≈ôidat `MapyCzProperties` + `application.yml` (`mapycz.*` s `${MAPYCZ_API_KEY}`).
- Implementovat `GeoConfig` (WebClient s timeouty, UA header, error filter).
- Dopsat `AddressSuggestion` (v≈°echna pole) a mapper z odpovƒõdi Mapy.cz.
- Opravit/doplnit `MapyCzGeoService.suggest(...)` ‚Äì validace vstup≈Ø, normalizace `q`.
- P≈ôidat cache layer (Caffeine) pro suggest.
- `GeoController` ‚Äì `GET /api/geo/suggest`, zapojit rate-limit filtr.
- Testy jednotkov√© + integraƒçn√≠ (ok/chyby/timeouty/edge cases).
- OpenAPI (schema DTO) + README pro geo modul.
- FE: `api.geo.suggest()` + debounce input (demo str√°nka ‚ÄûProjekt ‚Äì adresa‚Äú).

**FUTURE (roz≈°√≠≈ôen√≠):**
- Reverse geocoding (lon/lat ‚Üí adresa).
- Geocoding p≈ôes v√≠ce provider≈Ø (fallback).
- Perzistence ‚Äûposledn√≠ch v√Ωbƒõr≈Ø‚Äú pro UX.
- Validace PSƒå podle zemƒõ, normalizace diakritiky, detekce duplicit.
- Mapov√© widgety (piny, bbox zoom) v projektu a fakturaci.

### 11. 9. 2025 ‚Äî Docker Compose + .gitignore pro GEO API key

- P≈ôid√°n `docker-compose.yml` s p≈ôed√°n√≠m **MAPYCZ_API_KEY** do slu≈æby `backend`.
- Doplnƒõna pravidla do `.gitignore` pro **.env** a **.env***.
- Pozn.: Compose naƒç√≠t√° `.env` automaticky ze stejn√© slo≈æky jako `docker-compose.yml`.

### 12. 9. 2025 ‚Äî GEO fix Swagger + Mapy.com
- GeoController: explicitn√≠ `@RequestParam(name=...)` ‚Üí Swagger generuje `q/limit/lang` (ne arg0/1/2).
- maven-compiler: `<parameters>true</parameters>` kv≈Øli n√°zv≈Øm param≈Ø.
- MapyCzClient: `/v1/geocode` + `query=`.
- GeoService: bbox z listu [minLon,minLat,maxLon,maxLat]; regionalStructure.isoCode.
- Smoke test /api/v1/geo/suggest OK.

### 12. 9. 2025 ‚Äî Integrations/Weather (Meteostat RapidAPI)
- P≈ôid√°n modul `integrations/weather` (WebClient, klient, service, controller).
- Endpoint: `GET /api/integrations/weather/summary?lat&lon&date[&alt]`.
- √öƒçel: inline pou≈æit√≠ v Den√≠ku (automatick√© doplnƒõn√≠ poƒças√≠ k z√°znamu).


### 12. 9. 2025 ‚Äî Sprint 4: Finance & Dokumentace (MVP start)
**HOTOVO (pl√°n):**
- Detailn√≠ Step Plan pro moduly Invoices & Files (BE/FE/DB/i18n/RBAC).
- N√°vrh DB sch√©mat (Invoice, InvoiceLine, NumberSeries, StoredFile, FileTag, FileLink).
- API kontrakty v1 pro faktury a soubory.
- Akceptaƒçn√≠ krit√©ria + test plan.

**TODO (implementace):**
- [BE] Flyway migrace `invoices` + `files`.
- [BE] Services: NumberSeriesService, InvoiceService, InvoicePdfService, StoredFileService.
- [BE] Controllers + RBAC anotace + Swagger.
- [FE] Str√°nky /invoices a /files, formul√°≈ôe, RBAC guardy.
- [FE] API klienti invoices/files, i18n texty.
- [QA] Unit/Integration/E2E testy, CI green.

**FUTURE (PRO roz≈°√≠≈ôen√≠):**
- Verzov√°n√≠ soubor≈Ø, soft-delete/restore.
- Roz≈°√≠≈ôen√© ƒç√≠seln√© ≈ôady (v√≠ce pattern≈Ø, per projekt).
- ≈†ablony PDF (branding per company), v√≠cejazyƒçn√© PDF.
- S3/MinIO storage, AV scanning, signed URLs.

### 12. 9. 2025 ‚Äî Fix WebClient kolize
- MapyCzClient nyn√≠ pou≈æ√≠v√° @Qualifier("geoWebClient"), aby nedoch√°zelo ke kolizi s meteostatWebClient.

### 13. 9. 2025 ‚Äî Sprint 4: Finance a dokumentace (Invoices & Files)

**HOTOVO**
- P≈ôid√°n modul **Invoices**:
    - `NumberSeriesService` + unit testy (rezervace ƒç√≠sel, atomick√° transakce).
    - `InvoiceService` (CRUD, vystaven√≠, zmƒõna stavu).
    - `InvoiceController` + DTOs + Swagger anotace.
    - Integraƒçn√≠ test (`MockMvc`) pro z√°kladn√≠ akce.
- P≈ôid√°n modul **Files**:
    - Entita `StoredFile`, `FileTag`.
    - Slu≈æba `StoredFileServiceImpl` + jednotkov√© testy.
    - `FileStorage` interface + implementace `LocalFsStorage` (bean).
    - REST API: upload, download, tag management (RBAC scopes `files:*`).
- RBAC:
    - Anotace endpoint≈Ø `@PreAuthorize` s vyu≈æit√≠m `invoices:*`, `files:*` (dle RBAC_2.1).
- CI pro≈°lo (backend build + testy zelen√©).

**TODO (dal≈°√≠ krok ve Sprintu 4):**
- Implementace `InvoicePdfService` (export faktur do PDF s i18n form√°tov√°n√≠m).
- Propojen√≠ faktur s ARES (automatick√© doplnƒõn√≠ odbƒõratele).
- FE demo: modul fakturace + file upload (propojen√≠ s BE API).
- Integraƒçn√≠ testy `StoredFileController` (MockMvc: upload, download, 403 bez scope).

**FUTURE**
- Integrace se slu≈æbou e-mailu: `InvoiceEmailService` (odesl√°n√≠ faktur z√°kazn√≠k≈Øm).
- Roz≈°√≠≈ôen√≠ `FileStorage` o S3 implementaci (cloud).
- Verzionov√°n√≠ soubor≈Ø a archivace (PRO verze).

### 13. 9. 2025 ‚Äî FE Auth MVP skeleton

**HOTOVO**
- P≈ôid√°n skeleton autentizace na FE: `/login`, `AuthContext`, Axios klient + interceptory (TODO), guardy (`ProtectedRoute`, `ScopeGuard`), router a layout, i18n (common/auth/errors).
- Vytvo≈ôeny DTO typy: `LoginRequest/Response`, `RefreshRequest/Response`, `MeResponse`.

**TODO (dal≈°√≠ PR)**
- Implementace RHF + Zod validace ve `LoginPage`.
- Implementace interceptor≈Ø vƒçetnƒõ refresh singleflight a 401‚Üíretry.
- Napojen√≠ `/auth/me` a naplnƒõn√≠ `AuthContext` (user, role, scopes).
- UI toggle podle scopes v Sidebar/Projects.
- Unit & e2e testy dle pl√°nu.

**FUTURE**
- Persist bez localStorage (rehydratace p≈ôes `/auth/me` po refreshi).
- HttpOnly cookie pro refresh (pokud BE umo≈æn√≠) + CSRF varianta.
- Captcha/slowdown p≈ôi opakovan√©m 401/429.

### 14. 9. 2025 ‚Äî FE Auth implementace (MVP)

**HOTOVO**
- LoginPage (RHF+Zod, i18n, loading, 401/429).
- Axios interceptory s refresh singleflight a 401‚Üíretry; 403/429 UX hooky.
- AuthContext napojen na /auth/me (po loginu) ‚Äì naplnƒõn√≠ user/role/scopes.
- RBAC toggly: Sidebar a Projects (button ‚ÄûNov√Ω projekt‚Äú jen se scope).
- Unit test: hasScope (anyOf/allOf), kostry pro guards/interceptors/e2e.

**TODO**
- Doplnit integraƒçn√≠ test interceptor≈Ø (axios-mock-adapter).
- E2E: happy path login ‚Üí dashboard, RBAC sc√©n√°≈ôe (Playwright/Cypress).
- UI roz≈°√≠≈ôen√≠ (toasty, show/hide password, vizu√°ln√≠ stavy).
- Napojen√≠ re√°ln√Ωch Projects API.

**FUTURE**
- Persist bez localStorage (voliteln√° rehydratace p≈ôes /auth/me).
- HttpOnly cookie refresh varianta (pokud BE povol√≠) + CSRF.
- Anti-bruteforce UX p≈ôi 429 (cooldown/captcha).

### 14. 9. 2025 ‚Äî FE Auth MVP + UI knihovna

**HOTOVO**
- FE autentizace:
    - `LoginPage` p≈ôepracov√°n s **React Hook Form + Zod** validac√≠, i18n hl√°≈°kami, stavem loading, podporou 401/429.
    - Axios **interceptory** s refresh singleflight a retry pro 401, UX hooky pro 403/429.
    - **AuthContext** napojen na `/auth/me` ‚Äì po loginu pln√≠ `user/role/scopes`.
    - RBAC toggly v **Sidebaru** a v Projects (scope `projects:create`).
- UI knihovna:
    - Z√°kladn√≠ komponenty sjednoceny: `Button`, `LinkButton`, `Badge`, `Card*` (Card, Header, Title, Description, Content, Footer).
    - P≈ôid√°ny helpery: `cn` utilita, `icons` index pro lucide-react.
    - Instalace a zapojen√≠ **class-variance-authority**, **clsx**, **lucide-react**.
    - Zavedeny design tokens (`sb-*` classes) pro konzistenci.
- i18n:
    - Struktura `i18n/` s namespacy `common`, `auth`, `errors`, `projects`.
    - P≈ôipojeno do provider≈Ø v `main.tsx`.

**TODO (dal≈°√≠ kroky Sprintu 2)**
- Integraƒçn√≠ testy interceptor≈Ø (`axios-mock-adapter`).
- E2E testy login flow (happy path, RBAC sc√©n√°≈ôe) ‚Äì Cypress/Playwright.
- UI roz≈°√≠≈ôen√≠:
    - Toastery (shadcn/ui) m√≠sto fallback `console.log`.
    - Show/hide password toggle.
    - Lep≈°√≠ chybov√©/empty stavy.
- Napojen√≠ re√°ln√©ho **Projects API** (GET/POST).
- Dokonƒçit CI pro frontend (lint, build, test).

**FUTURE**
- Persist stav≈Ø bez localStorage (rehydratace p≈ôes `/auth/me` po refreshi).
- Voliteln√° varianta s refresh tokenem v HttpOnly cookie + CSRF tokeny.
- UX p≈ôi bruteforce/429 (cooldown, captcha).
- Roz≈°√≠≈ôen√≠ UI knihovny (`DataTable`, `Modal`, `EmptyState`) jako plnohodnotn√Ω ‚Äûstavbau-ui‚Äú bal√≠k pro v≈°echny feature moduly.
- Konsolidace design tokens (`tokens.css`) a theming (dark mode).

## üß≠ Rozhodnut√≠ architektury ‚Äî 15. 9. 2025
**T√©ma:** Registrace firmy & ƒçlenstv√≠ (Sprint 2)  
**Rozhodnut√≠:** Zavedeme `CompanyMember` pro RBAC/membership (OWNER atd.). `User` z≈Øst√°v√° ≈°t√≠hl√Ω (auth). Kontaktn√≠/fakturaƒçn√≠ √∫daje budou ≈ôe≈°eny samostatn√Ωm modulem **contacts/** a p≈ôes **invoices/Customer**. P≈ôiprav√≠me migraƒçn√≠ cestu `company_members.contact_id` (po zaveden√≠ contacts).  
**D≈Øvod:** ƒåist√© oddƒõlen√≠ Auth vs. Business, soulad s modular-monolith by feature a RBAC 2.1, sn√≠≈æen√≠ reworku.  
**Dopady:** DB constraint ‚Äû1 OWNER per company‚Äú, i18n kl√≠ƒçe, rate-limit na public endpointu, bez autologinu (verifikace pozdƒõji).

## ‚úÖ HOTOVO ‚Äì 15. 9. 2025
- Schv√°len ADR: CompanyMember (MVP) + future Contacts/Customer.
- Up≈ôesnƒõna akceptaƒçn√≠ krit√©ria a test plan pro registraci firmy + OWNER.

## üõ† TODO (Sprint 2/1 ‚Äì BE)
- [ ] Flyway: `company_members` + unique owner per company, uniq `companies(ico)`, uniq `lower(users.email)`.
- [ ] Registraƒçn√≠ slu≈æba: vytvo≈ôit Company, User (email+passwordHash+companyId), CompanyMember(OWNER).
- [ ] i18n: `company.exists`, `user.email.exists`, validaƒçn√≠ kl√≠ƒçe (cs/en).
- [ ] MockMvc + @DataJpaTest: happy path, duplicity, unique OWNER, i18n.

## üî≠ FUTURE
- Contacts modul (Contact/Person + Address) a napojen√≠ `company_members.contact_id`.
- E-mail verifikace + autologin po potvrzen√≠.
- Admin spr√°va ƒçlen≈Ø a rol√≠ (team:* scopes).

## ‚úÖ HOTOVO ‚Äì 15. 9. 2025
- DB: unik√°tn√≠ index `lower(users.email)` a `companies(ico)`.
- DB: zavedena tabulka `company_members` + constraint ‚Äû1 OWNER na firmu‚Äú.
- BE: `UserRepository` doplnƒõn o `existsByEmailIgnoreCase` a `findByEmailIgnoreCase`.
- BE: `CompanyRepository` s `findByIco` a `existsByIco`.
- BE: p≈ôid√°na entita a repo `CompanyMember`.

## üõ† TODO (Sprint 2/1 ‚Äì registrace)
- [ ] Dopl≈àit registraƒçn√≠ slu≈æbu: vytvo≈ôen√≠ `Company`, `User` (email+passwordHash+companyId), `CompanyMember(OWNER)`.
- [ ] Public endpoint `/api/v1/tenants/register` (permitAll + rate-limit).
- [ ] Integraƒçn√≠ testy: happy path, duplicita IƒåO / e-mail, unik√°tn√≠ OWNER, i18n.

## ‚úÖ HOTOVO ‚Äì 16. 9. 2025
- BE registrace firmy: funguj√≠c√≠ endpoint `POST /api/v1/tenants/register` (public).
- Vytvo≈ôen√≠ Company, User (email+passwordHash+companyId), CompanyMember(OWNER).
- Opraven NPE: inicializace `Company.sidlo` p≈ôed mapov√°n√≠m adresy.
- Ovƒõ≈ôeno p≈ôes Swagger/cURL (201 Created).

## üõ† TODO (Sprint 2/1 ‚Äì BE)
- [ ] Dopsat integraƒçn√≠ testy: 409 duplicitn√≠ IƒåO/e-mail, i18n, unique OWNER (DB).
- [ ] Omezit/odstranit DEV exception handler (detail DB chyb) mimo `local` profil.
- [ ] Nastavit rate-limit pro `/api/v1/tenants/register`.
- [ ] Swagger: doplnit `@Operation`, `@ApiResponse(409)` + example payloady.

## üî≠ FUTURE
- E-mail verifikace + autologin po potvrzen√≠.
- Contacts modul (napojen√≠ na ƒçleny p≈ôes `contact_id`).

## üõ† TODO ‚Äì Sprint 2/2 (FE)
- [ ] FE Registration Wizard (3 kroky): ARES ‚Üí n√°hled/edit ‚Üí owner+submit.
- [ ] Validace (Zod): ico, company, address, owner, terms.
- [ ] API vrstva: `api/companies.aresLookup`, `api/tenants.registerTenant`.
- [ ] i18n cs/en (errors.*, validation.*, labels.*, steps.*).
- [ ] Error mapping: 409 company.exists/user.email.exists, 400 validation, 429 rate limit.
- [ ] UX: loading/disabled, retry, sessionStorage, a11y fokus.
- [ ] Testy: RTL (unit/integration) + e2e (happy/duplicitn√≠ sc√©n√°≈ôe).

## ‚úÖ HOTOVO ‚Äì 16. 9. 2025
- Schv√°len a p≈ôipraven FE Step Plan pro registraci (3 kroky) vƒç. DTO, validac√≠, i18n, UX a test pl√°nu.

### 18. 9. 2025 ‚Äî Team (Company Members) ‚Äî BE skeleton
- **P≈ôid√°no:** TeamMembersController (POST/GET/PATCH/DELETE skeleton), DTO (`CreateMemberRequest`, `UpdateMemberRequest`, `MemberDto`, `MemberListResponse`), `TeamService` + `TeamServiceImpl` (stubs), `MemberMapper` (stub), WebMvcTest stub.
- **Security:** RBAC scopy a companyId guard **zat√≠m ne** (p≈Øjde do PR 3/N).
- **i18n:** Seed kl√≠ƒçe v `errors_cs/en`.
- **Swagger:** Tag `Team` + z√°kladn√≠ operace.
- **Dopad:** Bez DB zmƒõn; CI zelen√©.

## ‚úÖ HOTOVO (19. 9. 2025)
- Zavedeno jednotn√© i18n API: `cz.stavbau.backend.common.i18n.Messages`.
- Zavedena hierarchie dom√©nov√Ωch v√Ωjimek: `DomainException`, `ConflictException`.
- Refactor `CompanyRegistrationServiceImpl` na `Messages` + `ConflictException`.
- Doplnƒõny z√°kladn√≠ unit testy pro `Messages`.

## üìå TODO
- Proj√≠t ostatn√≠ slu≈æby a nahradit lok√°ln√≠ `msg()` + vno≈ôen√© v√Ωjimky.
- Roz≈°√≠≈ôit `ApiExceptionHandler` o jednotn√© mapov√°n√≠ v≈°ech `DomainException` s RFC7807.
- (Voliteln√©) Zav√©st `ErrorCode` enum a metodu `messages.msg(ErrorCode, args...)`.

## üí° FUTURE
- Centralizovat validaƒçn√≠ k√≥dy do `validation.properties` a sjednotit kl√≠ƒçe nap≈ô√≠ƒç moduly.

### 19. 9. 2025 ‚Äî Team (Company Members) ‚Äî PR 2B (BE service)

- **Implementov√°no:** `TeamServiceImpl` (add/list/update/remove) + lok√°ln√≠ helpery (normalizeEmail/validateEmail/requireTeamRole) + mapov√°n√≠ **TeamRole‚ÜíCompanyRoleName** (`ADMIN‚ÜíCOMPANY_ADMIN`, `MEMBER‚ÜíVIEWER`).
- **Invite flow (MVP):** nov√Ω u≈æivatel se zakl√°d√° se `state=INVITED`, `passwordNeedsReset=true`, `invitedAt=now()`, `passwordHash=BCrypt(random)`. `MemberDto.status` je odvozen√Ω (`INVITED|CREATED`).
- **Mapper:** `MemberMapper` ƒçte jm√©no/telefon z `CompanyMember` (`firstName/lastName/phone`).
- **Guardy & konflikty:** 403 `errors.forbidden.company.mismatch` (companyId mismatch), 403 `errors.owner.last_owner_forbidden` (z√°kaz zmƒõny/odebr√°n√≠ OWNERa), 409 `member.exists`, 409 `user.assigned_to_other_company`, 404 `errors.not.found.member`.
- **i18n:** doplnƒõno `errors.forbidden.company.mismatch` (cs/en) a `errors.validation.role.invalid`.
- **Security:** RBAC scopy `team:read|write` a controller guard na `{companyId}` budou ≈ôe≈°en√© v **PR 3/N** (≈æ√°dn√° zmƒõna `SecurityConfig` v tomto PR).
- **DB:** bez zmƒõn sch√©matu; pokud chybƒõly sloupce `first_name/last_name/phone` u `company_members`, doplnƒõn minor patch `V2025_09_19_002__company_member_contact_fields.sql`.
- **CI:** unit testy (invited flow, user v jin√© firmƒõ, OWNER guard) ‚Äî **zelen√©**.

### 20. 9. 2025 ‚Äî Sprint 2/1: Team (Company Members) ‚Äî checkpoint

**Hotovo (BE)**
- PR 2A: P≈ôid√°n stav u≈æivatele a invite flagy
    - `users.state (INVITED|ACTIVE|DISABLED|LOCKED)`, `users.password_needs_reset`, `users.invited_at`.
    - `User` roz≈°√≠≈ôen o nov√© fieldy; JPA smoke test OK.
- PR 2B: Implementov√°na business logika TeamService
    - `TeamServiceImpl` (add/list/update/remove), lok√°ln√≠ helpery (normalizeEmail/validateEmail/requireTeamRole, generateRandomSecret).
    - Mapov√°n√≠ **TeamRole ‚Üí CompanyRoleName** (`ADMIN‚ÜíCOMPANY_ADMIN`, `MEMBER‚ÜíVIEWER`).
    - Guardy a konflikty: `member.exists`, `user.assigned_to_other_company`, `errors.owner.last_owner_forbidden`, `errors.not.found.member`.
    - `MemberMapper` ƒçte `firstName/lastName/phone` z `CompanyMember`.
    - (Pokud chybƒõlo) mikro migrace `company_members.{first_name,last_name,phone}` doplnƒõna.
- PR 3: Controller + RBAC + companyId guard
    - `TeamMembersController` (POST/GET/PATCH/DELETE) + `@PreAuthorize` (`team:read|team:write`).
    - `BuiltInRoles`: OWNER/COMPANY_ADMIN ‚Üí read+write; VIEWER/AUDITOR_READONLY ‚Üí read.
    - Company guard: path `{companyId}` vs principal.companyId (p≈ôes `@AuthenticationPrincipal`).
    - Swagger: sekce **Team** viditeln√° a bƒõ≈æ√≠.
    - Drobn√© v√Ωjimky: `NotFoundException`, `ForbiddenException` doplnƒõny.
    - Oprava utilu/varianty pro `currentCompanyId()` (Optional nebo obalen√≠ v controlleru).

**Hotovo (i18n & errors)**
- P≈ôid√°ny/ujasnƒõny kl√≠ƒçe:
    - `errors.forbidden.company.mismatch` (cs/en),
    - `errors.validation.role.invalid`,
    - re-use: `errors.member.exists`, `errors.user.assigned_to_other_company`, `errors.owner.last_owner_forbidden`, `errors.not.found.member`, `errors.validation.email`.

**Hotovo (FE p≈ô√≠prava)**
- Vyjasnƒõna integrace FE skeletonu (PR 4/N) bez duplicit: pou≈æ√≠t `lib/api/client.ts`, sd√≠len√© typy v `lib/api/types.ts`.
- P≈ôipraven prompt pro nov√© vl√°kno: **PR 4/N ‚Äî FE skeleton: Team** (route `/app/team`, TeamPage, TeamService nad existuj√≠c√≠m klientem, i18n, msw, smoke test).

**Dopad na security**
- Aktivn√≠ scopy `team:read|team:write` + p≈ôi≈ôazen√≠ k rol√≠m v `BuiltInRoles`.
- CompanyId guard na v≈°ech Team endpointech (403 p≈ôi mismatch).
- Rate-limit zat√≠m **neaktivov√°n** pro tyto endpointy (viz TODO).

---

**TODO (nejbli≈æ≈°√≠)**
- **PR 3a:** zapnout rate-limit (nap≈ô. 5/min) pro `POST /members` a `DELETE /members/{memberId}`; i18n `errors.rate.limit` + RFC7807 mapping na 429.
- **PR 4/N (FE skeleton):**
    - Route `/app/team` s `ProtectedRoute` + `ScopeGuard(['team:read'])`.
    - `TeamService` **nad** `lib/api/client.ts` (≈æ√°dn√Ω nov√Ω Axios klient).
    - Typy **do** `lib/api/types.ts` (TeamRole, MemberDto, MemberListResponse, Create/UpdateMemberRequest).
    - `TeamPage` (tabulka, loading/empty/error).
    - i18n `team.json` (cs/en) + p≈ôipojen√≠ do initu.
    - MSW handler GET (pr√°zdn√Ω seznam) + smoke test.
- **PR 5/N (FE actions):** Add member (modal), Change role, Remove (confirm), error mapping (RFC7807‚Üíi18n), MSW pro POST/PATCH/DELETE, testy (unit + msw).
- **PR 6/N (E2E):** z√°kladn√≠ e2e sc√©n√°≈ô (login ‚Üí /app/team ‚Üí add ‚Üí change role ‚Üí remove), CI job.

**Future (po MVP)**
- Invite e-mail flow: invitation token + expirace, resend, aktivace √∫ƒçtu (endpoint), audit.
- Paging/sorting pro `GET /members` + filtr role.
- Konsolidace ProblemDetails (st√°l√Ω `code` na BE, sd√≠len√Ω FE mapper).
- Audit log roz≈°√≠≈ôit (structured logging, korelace, metriky).
- P≈ôechod na **contacts/**: `company_members.contact_id` + p≈ôesun osobn√≠ch √∫daj≈Ø (zpƒõtnƒõ kompatibiln√≠ mapper).
- Roz≈°√≠≈ôen√≠ RBAC (jemn√© scopy `team:add|remove|update_role` pro PRO tarif).
- Swagger: doplnit p≈ô√≠klady request/response (201/409/403/404/429) a k√≥dy chyb.

### 20. 9. 2025 ‚Äî RBAC claims a jemn√© scopy

- **RBAC:** Naplnƒõny jemn√© scopy `team:add`, `team:remove`, `team:update_role` atd. v `BuiltInRoles`.
- **Login:** Upraven `AuthController.login()` ‚Äì access token nyn√≠ p≈ôi zapnut√©m `rbacClaimsEnabled` obsahuje `companyRole` a `scopes[]` (fallback na legacy varianta beze zmƒõny).
- **/auth/me:** Roz≈°√≠≈ôeno o `companyRole`, `projectRoles[]`, `scopes[]`.
- **Repo:** Zavedeno vyƒçten√≠ role u≈æivatele z `CompanyMember` (varianta B: naƒçten√≠ entity a ƒçten√≠ z pole `role`).
- **Docs:** Aktualizov√°no `RBAC_2.1_STAVBAU_V2.md` (scopes, mapping).
- **V√Ωsledek:** `/auth/me` vrac√≠ kompletn√≠ RBAC kontext; login je stabiln√≠ i p≈ôi chyb√°ch v RBAC ƒç√°sti (fail-safe fallback).

### 21. 9. 2025 ‚Äî Konvence ID a /auth/me roz≈°√≠≈ôen√≠

- **BE:** Upraveno `MeResponse` (pole `id` m√≠sto `userId`) a p≈ô√≠slu≈°n√Ω controller.
- **Docs:** Doplnƒõn odstavec o konvenci ID (UUID pouze `id`) do `STAVBAU_GUIDELINES.md`.
- **OpenAPI:** Snippet `/auth/me` aktualizov√°n ‚Äì `id`, `companyId`, `companyRole`, `projectRoles[]`, `scopes[]`.
- **Dopad:** Konsolidace ID konvenc√≠ pro v≈°echny entity a DTO ‚Üí do budoucna nebude nutn√Ω rework.

### 21. 9. 2025 ‚Äî RBAC & AuthService refactor

- **RBAC roz≈°√≠≈ôen√≠**
    - P≈ôid√°ny jemn√© scopy `team:add`, `team:remove`, `team:update_role`.
    - Roz≈°√≠≈ôen `BuiltInRoles.COMPANY_ROLE_SCOPES` podle n√°vrhu z `RBAC_2.1_STAVBAU_V2.md`.
    - `/auth/me` nyn√≠ vrac√≠ i `companyRole`, `projectRoles[]`, `scopes[]`.

- **AuthController ‚Üí AuthService**
    - Vytvo≈ôena servisn√≠ t≈ô√≠da `AuthService` (metody `login`, `refresh`, `logout`, `buildMeResponse`).
    - Controller refaktorov√°n na tenkou vrstvu ‚Äì pouze deleguje na `AuthService`.
    - Zavedeno DTO `RefreshResponse` pro konzistentn√≠ odpovƒõƒè `/auth/refresh`.
    - N√°vratov√© typy z `AuthService` refaktorov√°ny: m√≠sto cel√©ho `Set-Cookie` header stringu vrac√≠ ƒçist√Ω `cookieValue` a DTO (`AuthResponse` / `RefreshResponse`).
    - V `AuthController` t√≠m odpadl hack se `substring("Set-Cookie: ".length())`.

- **Konzistence ID**
    - Zavedena konvence: v≈°echny entity dƒõd√≠ z `BaseEntity` (`id: UUID`).
    - Upraveno `MeResponse` a `AuthController` ‚Äì FE dost√°v√° jednotnƒõ pole `id`.
    - Doplnƒõna dokumentace do `STAVBAU_GUIDELINES.md` + snippet do `openapi.yml`.

## 2025-09-21 ‚Äî PR 4/N ‚Äî FE skeleton: Team / Company Members

### HOTOVO
- **Router:** p≈ôid√°na chr√°nƒõn√° route `/app/team` (ProtectedRoute + ScopeGuard `required=['team:read']`, bez nov√© router instance).
- **TeamPage:** skeleton (stavy `loading / empty / error`, tabulka: *E-mail*, *Role* ‚Äî company role z BE, *Jm√©no*, *Telefon*); ƒçten√≠ `companyId` z Auth (`useAuthContext`).
- **API typy (centr√°lnƒõ):** `lib/api/types.ts` roz≈°√≠≈ôeno o `TeamRole`, `CompanyRole`, `MemberDto`, `MemberListResponse`, `CreateMemberRequest`, `UpdateMemberRequest`.
- **TeamService:** `features/team/api/team.service.ts` (pouze existuj√≠c√≠ `lib/api/client.ts`; metody `list/add/update/remove`; normalizace `memberId ‚Üí id`; guard na `cancel`/`abort`; sd√≠len√© mapov√°n√≠ chyb).
- **Sd√≠len√© mapov√°n√≠ chyb:** `lib/api/problem.ts` (`toApiProblem`, `ApiError`, `mapAndThrow`) a zapojen√≠ v TeamService.
- **i18n:** p≈ôid√°n namespace `team` (cs/en) + registrace v `src/i18n/index.ts`.
- **MSW:** handler `GET /api/v1/tenants/:companyId/members` ‚Üí `{ items: [] }`; agregace v `mocks/handlers`, worker v DEV, `setupTests.ts` pro Vitest.
- **Testy:** smoke test `TeamPage` (render title ‚ÄûT√Ωm‚Äú) s mock Auth (scopes `['team:read']`, `companyId`).

### DoD / ovƒõ≈ôeno
- Build + testy + MSW **OK**; `/app/team` je chr√°nƒõn√° a naƒçte pr√°zdn√Ω seznam.
- **Bez nov√©ho Axios klienta** (pou≈æit `lib/api/client.ts`), typy jsou **centr√°lnƒõ** v `lib/api/types.ts`, error-mapper je **sd√≠len√Ω** v `lib/api/problem.ts`.
- **≈Ω√°dn√© duplicity** soubor≈Ø v≈Øƒçi st√°vaj√≠c√≠mu repo stavu.
- Commity dle **Conventional Commits**, PR popis + ≈°t√≠tky + **CODEOWNERS**.

### TODO (PR 5/N)
- Akce na TeamPage: **add/remove/update role** (scope `team:write`), formul√°≈ôe a validace.
- MSW + testy pro **POST/PATCH/DELETE**; zobrazen√≠ field-errors z BE.
- i18n labely pro company role/status; UI badge pro `status`.
- (Volitelnƒõ) mapov√°n√≠ `CompanyRole ‚Üí i18n` na jednom m√≠stƒõ.

### FUTURE
- Paging/filtrace/≈ôazen√≠ + hled√°n√≠ (email/jm√©no).
- Detail ƒçlena + proklik na profil.
- Contract testy FE/BE a E2E flow.
- V√Ωkon: virtualizace tabulky pro velk√© seznamy.

---

## üîú TODO (dal≈°√≠ sprint)

- **Testy**
    - Unit testy: `BuiltInRolesTest`, `AuthServiceTest` (happy path login/refresh, 401 p≈ôi ≈°patn√©m hesle, 403 p≈ôi scope chybƒõ).
    - Slice testy: `@WebMvcTest` pro `AuthController` (`/login`, `/refresh`, `/me`).
    - Integraƒçn√≠ testy: end-to-end login ‚Üí refresh ‚Üí p≈ô√≠stup k chr√°nƒõn√©mu endpointu.

- **i18n**
    - P≈ôidat kl√≠ƒçe `auth.invalid_credentials`, `auth.refresh_revoked`, `auth.forbidden_missing_scope`.

---

## üí° FUTURE

- Migrace RBAC do DB (`role_definitions`, `scope_definitions`, `role_scopes`).
- FE hooky: `useHasScope(scope)`, `ScopeGuard`.
- Admin UI pro spr√°vu rol√≠ a scopes.

## 2025-09-21 ‚Äî FE Team / Layout / UI (PR 4/N + ƒç√°st 5/N)
‚úÖ Hotovo

Routing & Guards

P≈ôid√°na route /app/team v src/routes/router.tsx p≈ôes ProtectedRoute + ScopeGuard(['team:read']).

Opraveno API ScopeGuard (prop anyOf), sjednocen√© pou≈æit√≠.

Auth

useAuth()/useAuthContext() bez state wrapperu; ƒçten√≠ user.companyId.

Typy (lib/api/types.ts)

TeamRole = 'ADMIN' | 'MEMBER'.

CompanyRole (OWNER, COMPANY_ADMIN, ‚Ä¶, SUPERADMIN).

MemberDto, MemberListResponse, CreateMemberRequest, UpdateMemberRequest, UpdateMemberRoleRequest.

API klient

features/team/api/team.service.ts (bez nov√©ho axios klienta; pou≈æ√≠v√° lib/api/client.ts), normalizace payload≈Ø z BE.

Sd√≠len√© mapov√°n√≠ chyb lib/api/problem.ts + ApiError.

TeamPage (features/team/pages/TeamPage.tsx)

Skeleton tabulky (email, role, jm√©no, telefon) + loading/empty/error.

Add Member panel (email, role, jm√©no, p≈ô√≠jmen√≠, telefon) + tolerantn√≠ validace e-mailu.

Update Role (inline select) s FE/BE guardy:

Nelze nastavovat SUPERADMIN ani OWNER z tenant UI.

Nelze mƒõnit roli ƒçlena s OWNER (hl√≠d√° FE i BE).

FE ochrana ‚Äûlast owner‚Äú (nelze ‚Äûsundat‚Äú posledn√≠ho vlastn√≠ka).

Edit Profile p≈ôes MemberEditModal (PATCH detailu ƒçlena; p≈ôipraveno na roz≈°i≈ôov√°n√≠ pol√≠).

Delete Member (guard posledn√≠ho OWNERa + chybov√© stavy).

Integrace DataTable (@/components/ui/stavbau-ui) + akƒçn√≠ sloupec s ikonami.

UI pou≈æ√≠v√° Button a ikony z @/components/icons.

Zobrazen√≠ deleteError inline pod ≈ô√°dkem (fix ‚Äûnever read‚Äú).

i18n

team.json (cs/en): title, columns, actions, errors (notAssignable, onlySuperadminOwner, lastOwner) a placeholdery.

MSW

Z√°kladn√≠ handler GET /api/v1/tenants/:companyId/members (pr√°zdn√Ω/uk√°zkov√Ω list) zapojen do mocks/handlers.

UI/UX ‚Äì spoleƒçn√© komponenty

SearchInput (aliasy ikon, default styly pro left/right ikonu).

patterns.ts (EMAIL_INPUT_PATTERN, EMAIL_REGEX, EMAIL_REGEX_STRICT) a sjednocen√© pou≈æ√≠v√°n√≠.

Sidebar: aktivn√≠ stav + ‚Äûsticky‚Äú indik√°tor (pseudo-element), util getNavClass({isActive}), a11y + i18n.

AppLayout: integrace prvk≈Ø z v1 bez duplicit

FabProvider, MobileFab (‚â§ md), MobileBottomBar (‚â§ md).

TopbarActions slot (desktop) ‚Äì jedin√Ω zdroj pravdy pro str√°nkov√© akce.

Topbar upraven, Sidebar zachov√°n.

RBAC scopy (FE)

Add: team:write | team:add

Update role: team:write | team:update_role

Delete: team:write | team:remove

Read: team:read

üß™ Test/Infra

Zalo≈æen smoke test pro TeamPage (render title) ‚Äì (doplnit, pokud je≈°tƒõ nen√≠).

Ignorov√°n√≠ cancel chyb (Axios/Abort/ApiError) ve v≈°ech efektech.

üìù BE pozn√°mky (sladƒõno s FE)

POST (p≈ôid√°n√≠): @PreAuthorize("@rbac.hasAnyScope('team:write','team:add')").

PATCH role: @PreAuthorize("@rbac.hasAnyScope('team:write','team:update_role')"), z√°kaz zmƒõny OWNER, validace role.

PATCH detailu membera: navr≈æeno (jm√©no/p≈ô√≠jmen√≠/telefon) ‚Äì sladƒõno s FE modalem.

DELETE: z√°kaz smaz√°n√≠ posledn√≠ho OWNERa, guard companyId; scopy: team:write | team:remove.

‚è≠ Todo (dal≈°√≠ PR 5/N kroky)

MSW: doplnit handlery POST/PATCH/DELETE + field-errors.

Testy: integraƒçn√≠ testy (add/update/delete), i18n kl√≠ƒçe, a11y (axe).

TeamPage: badge pro status, centralizovan√© mapov√°n√≠ CompanyRole ‚Üí i18n.

Topbar: volitelnƒõ roz≈°√≠≈ôit ‚Äûright actions‚Äú slot pro v√≠ce tlaƒç√≠tek (multi-fab).

üî≠ Future

DataTable v2: server-side paging/sorting/filters, column visibility, density, toolbar, export, mobiln√≠ ‚Äûcards‚Äú layout, virtualizace (dle pot≈ôeby). ‚Üí Zah√°jeno nov√Ωm vl√°knem (Step Plan p≈ôipraven).

Form validace: spoleƒçn√Ω useZodForm/useForm helper (podle pot≈ôeby).

RBAC FE: centralizovat mapov√°n√≠ scop≈Ø ‚Üí UI capabilities.

## ‚úÖ HOTOVO ‚Äì 22. 9. 2025
- FE test runner: p≈ôid√°n `vitest.config.ts` s aliasem `@ -> ./src` a `vite-tsconfig-paths`.
- Vite config sjednocen s aliasy.
- Importy upraveny na explicitn√≠ soubory (`empty-state`), sjednocen n√°zev `datatable.tsx`.

## ‚ñ∂Ô∏è TODO
- Ovƒõ≈ôit `npx vitest --config vitest.config.ts`.
- Po pr≈Øchodu test≈Ø nav√°zat **PR 2 ‚Äì Sorting + MSW demo**.

## ‚úÖ HOTOVO ‚Äì 22. 9. 2025
- FE testy: p≈ôid√°n testovac√≠ i18n init (src/test/i18n.ts) + import v setupTests; odstranƒõno varov√°n√≠ NO_I18NEXT_INSTANCE.

## ‚ñ∂Ô∏è TODO
- PR 2 ‚Äì Sorting (controlled/uncontrolled) + MSW demo (header kliky, aria-sort, testy).

## ‚úÖ HOTOVO ‚Äì 22. 9. 2025
- FE ‚Äì DataTable v2 (PR 2/5): Sorting (controlled/uncontrolled) p≈ôes TanStack.
    - Header interakce (klik/shift-klik/kl√°vesy), aria-sort indikace.
    - i18n kl√≠ƒçe `datatable.sort.*`.
    - Testy: cyklov√°n√≠ ≈ôazen√≠ + ovƒõ≈ôen√≠ po≈ôad√≠.
    - MSW: demo handler `/api/v1/demo/list` se `sort[]`.

## ‚ñ∂Ô∏è TODO
- PR 3 ‚Äì Paging (server/client) + pager komponenta + testy.

## ‚úÖ HOTOVO ‚Äì 22. 9. 2025
- Revert DataTable v2 (f2a0a6f..HEAD) proveden na vƒõtvi hotfix/revert-datatable a odesl√°n jako PR.

## ‚ñ∂Ô∏è TODO
- Merge PR do main a ovƒõ≈ôit `npm ci && npm run dev`.
- Nastavit branch protection na main.
- Zalo≈æit `feature/datatable-v2` a doruƒçit PR 1 (TanStack wrapper) izolovanƒõ od runtime.

## ‚úÖ HOTOVO ‚Äì 23. 9. 2025
- Test stack: doinstalov√°n vitest@^3, jsdom@^25, vite-tsconfig-paths@^5.
- tsconfig.types doplnƒõn o "vitest/globals"; restart TS serveru.

## ‚ñ∂Ô∏è TODO
- Spustit `npx vitest` (ovƒõ≈ôit).
- Pot√© PR 1 (DataTableV2 shell) + mini test.

## ‚úÖ HOTOVO ‚Äì 22. 9. 2025
- FE ‚Äì DataTable v2 (PR 1 restart): P≈ôid√°n bezpeƒçn√Ω shell nad @tanstack/react-table.
    - Bez i18n/MSW, bez dopadu na bƒõh appky.
    - Z√°kladn√≠ test (render/skeleton/rows).
    - Node & CI sjednocen√≠, lockfile regenerov√°n, testy OK.

## ‚ñ∂Ô∏è TODO
- PR 2 ‚Äì Sorting (controlled/uncontrolled) + a11y (aria-sort).
- PR 3 ‚Äì Paging (server/client) + Pager.
- PR 4 ‚Äì Toolbar (search, visibility, density, i18n kl√≠ƒçe).
- PR 5 ‚Äì Row actions slot + p≈ô√≠klad integrace (TeamPage).

## ‚úÖ HOTOVO ‚Äì 23. 9. 2025
- DataTableV2 PR2: opraveno vol√°n√≠ toggleSorting (shift p≈ôed√°v√°n jako multi, ne desc).
- Test `datatable-v2.sort.spec.tsx` proch√°z√≠ (aria-sort cyklus OK).

## ‚ñ∂Ô∏è TODO
- PR 3 ‚Äì Paging (server/client) + Pager komponenta + testy.

## ‚úÖ HOTOVO ‚Äì 23. 9. 2025
- FE ‚Äì DataTableV2 (PR 3): Paging (client/server), pager UI, a11y.
- Testy: client paging (2/strana, navigace), controlled re≈æim (onPageChange + rerender).

## ‚ñ∂Ô∏è TODO
- PR 4 ‚Äì Toolbar: search, column visibility, density; p≈ôipravit i18n kl√≠ƒçe.

## ‚úÖ HOTOVO ‚Äì 23. 9. 2025
- FE ‚Äì DataTableV2 (PR 4): Toolbar (search state, column visibility, density).
- i18n: p≈ôid√°ny kl√≠ƒçe common.datatable.* (cs/en).
- Testy: visibility toggle, density toggle.

## ‚ñ∂Ô∏è TODO
- PR 4.1 ‚Äì Toolbar pokraƒçov√°n√≠: page size selector (5/10/20), reset filtr≈Ø, export CSV (voliteln√©).
- PR 5 ‚Äì Row actions slot + integrace v TeamPage.

## ‚úÖ HOTOVO ‚Äì 23. 9. 2025
- FE ‚Äì DataTableV2 (PR 4.1): page size selector (5/10/20) + Reset filtr≈Ø.
- Testy: page size (client/server), reset stav≈Ø.

## ‚ñ∂Ô∏è TODO
- PR 5 ‚Äì Row actions slot + integrace (TeamPage).
- PR X ‚Äì (volitelnƒõ) export CSV v Toolbaru.

## ‚ñ∂Ô∏è TODO
- PR 5 ‚Äì Row actions slot + integrace v TeamPage (guardy, a11y).

## ‚úÖ HOTOVO ‚Äì 23. 9. 2025
- FE: TeamPageV2 ‚Äì pln√° integrace DataTableV2 (toolbar, client paging, row actions).

## ‚ñ∂Ô∏è TODO (dal≈°√≠ PR)
- PR 6: per-row async stav (spinner/disable) sjednotit p≈ôes helper (useAsyncAction) + toast pattern.
- PR 7: server-side re≈æim (page, sort, filters) napojit na TeamService.list s query parametry.
- PR 8: p≈ôepnout column visibility trigger z <details>/<summary> na <button> + popover (lep≈°√≠ a11y).

## ‚úÖ HOTOVO ‚Äì DataTableV2 theme toggle
- props: variant: 'surface' | 'plain' (default 'plain')
- props: className: string
- shell aplikuje variantu na wrapper (card/border/zebra pro 'surface')

## ‚úÖ HOTOVO ‚Äì DataTableV2 Toolbar: SearchInput (preset v1)
- Nahrazen plain <input> ‚Üí <SearchInput /> z UI kitu
- A11y: ariaLabel, placeholder (i18n-ready)
- Vizu√°l: v1 preset = shoda s p≈Øvodn√≠m vzhledem

## ‚úÖ HOTOVO ‚Äì UI Select (native)
- Nov√° komponenta <Select /> v stavbau-ui (a11y-first, mobile-friendly).
- API: value/defaultValue/onChange, options|children, size, variant, icons, error/helper.
- Integrace: DataTableV2 Toolbar ‚Äì ‚ÄûPoƒçet na str√°nku‚Äú pou≈æ√≠v√° <Select />.

## ‚ñ∂Ô∏è FUTURE
- Voliteln√° ‚Äûlistbox‚Äú varianta (custom popover) pro speci√°ln√≠ p≈ô√≠pady.
- Virt. dlouh√Ωch seznam≈Ø (do 1k+ polo≈æek) ‚Äì a≈æ bude pot≈ôeba.
- label/description props p≈ô√≠mo v Select (intern√≠ <label>)

## ‚úÖ HOTOVO ‚Äî DataTableV2 (23. 9. 2025)

### Funkcionalita
- **Z√°kladn√≠ shell**
    - Plnƒõ typovan√° generick√° komponenta `DataTableV2<T>`
    - Podpora variant vzhledu: `plain` a `surface`
    - Responsivn√≠ chov√°n√≠, konzistentn√≠ design se zbytkem `stavbau-ui`

- **Toolbar**
    - üîç **SearchInput** (n√°≈° vlastn√≠) s i18n texty
    - üëÅ **ColumnVisibilityMenu** s podporou variant (`details`/`popover`)
    - üî¢ **PageSize Select** ‚Äì poƒçet z√°znam≈Ø na str√°nku (napojen√Ω na n√°≈° `Select`)
    - üìè **DensitySelect** ‚Äì v√Ωbƒõr hustoty ≈ô√°dk≈Ø (`compact`, `cozy`, `comfortable`)
    - üîÑ **Reset filters** tlaƒç√≠tko (resetuje stav tabulky)
    - üìä Indik√°tor str√°nky `p / c`

- **Hlavn√≠ tabulka**
    - Sorting (cyklus none ‚Üí asc ‚Üí desc, shift-click = multi-sort)
    - Paging (`page`, `pageSize`, `pageCount`, prev/next)
    - Row click handler (`onRowClick`)
    - Slot pro **rowActions** (nap≈ô. ikony pro editaci/smaz√°n√≠)
    - EmptyState (vƒçetnƒõ i18n text≈Ø)
    - Skeleton loading stavy

- **UX / i18n**
    - V≈°echny texty p≈ôes `react-i18next` (`common.json`)
    - P≈ô√≠stupnost: aria atributy (`aria-sort`, `aria-label`, `aria-live`)
    - Testy: unit testy pro shell, sorting, toolbar, actions

---

## üõ†Ô∏è FUTURE ‚Äî DataTableV2

- [ ] **Server-side re≈æim** (props `manualSorting`, `manualPaging`, API integrace)
- [ ] **Persistovan√© preference u≈æivatele** (ulo≈æen√≠ sloupc≈Ø/density/pageSize do localStorage nebo BE)
- [ ] **Exporty** (CSV, XLSX, PDF)
- [ ] **Drag & drop reordering** sloupc≈Ø
- [ ] **Inline editace bunƒõk** (RHF + validace)
- [ ] **Filtrace per-column** (dropdowny, datumov√© range, multiselect)
- [ ] **Virtualizace ≈ô√°dk≈Ø** (pro velk√© datasety)
- [ ] **Dark mode ladƒõn√≠** (ovƒõ≈ôit kontrasty pro v≈°echny varianty)

## üü® TODO ‚Äî DataTableV2 ‚Äì Responsive (Hybrid)

**C√≠l:** P≈ôidat responzivn√≠ vzhled DataTableV2 bez zmƒõny funkƒçnosti:
- `<md` (mobil): stacked cards (Title, Subtitle, 3‚Äì5 detail≈Ø, akce).
- `md‚Äìlg`: scrollable tabulka se sticky kl√≠ƒçov√Ωmi sloupci.
- `‚â•lg`: beze zmƒõny (pln√° tabulka).

**Step Plan:**
1) API pro ‚Äúcard fields‚Äù (bez UI zmƒõn)
    - Sloupce: `priority`, `isTitle`, `isSubtitle`, `mobileHidden`, `formatter`.

2) `<md` Stacked cards (MVP)
    - `<DataRowCard />`: `rounded-2xl shadow-sm border p-3 space-y-2`.
    - ‚ÄúZobrazit v√≠ce‚Äù pro zbytek sloupc≈Ø; akce v kebabu/patiƒçce.

3) `md‚Äìlg` Scrollable table + sticky
    - `overflow-x-auto`, `min-w-*`; sticky 1‚Äì2 kl√≠ƒçov√© sloupce (left), volitelnƒõ akce (right).

4) Polishing & A11y
    - Focus ringy, `aria-label` u ikon, `aria-expanded` u ‚ÄúZobrazit v√≠ce‚Äù, `line-clamp`.

5) Dokumentace & usage guidelines
    - README: znaƒçen√≠ `isTitle`, `priority`, `mobileHidden`, p≈ô√≠klady.

6) Kontrola konzistence (stavbau-ui)
    - Radius, spacing, st√≠ny, barvy; srovnat s dal≈°√≠mi list komponentami.

**Akceptaƒçn√≠ krit√©ria:**
- Mobil bez horizont√°ln√≠ho scrollu; ƒçiteln√© karty (nezalamuj√≠ layout).
- `md‚Äìlg` p≈ôirozen√Ω H-scroll + viditeln√© kl√≠ƒçov√© informace (sticky).
- `‚â•lg` beze zmƒõny.
- P≈ô√≠stupnost (tab stop po≈ôad√≠, kontrast) a v√Ωkon (100+ ≈ô√°dk≈Ø OK).

**Test Plan:**
- Za≈ô√≠zen√≠: iPhone SE/13 Pro Max, Pixel 5/7, iPad mini, 1280/1440 px.
- Interakce: akƒçn√≠ menu, multi-select, empty/loading/error.
- A11y: ARIA popisky, focus ringy.
- V√Ωkon: dlouh√© seznamy (chunking/virtualizace pokud zapnuta).

**Rollback:** `responsiveMode="off"` vr√°t√≠ p≈Øvodn√≠ chov√°n√≠.

**Pozn√°mky:**
- PR dƒõlit do mal√Ωch krok≈Ø (~200 LOC).
- Po ka≈æd√©m merge p≈ôidat checkpoint do t√©to ƒçasov√© osy.

## ‚úÖ 2025-09-24 ‚Äî DataTableV2 Responsive (komplet Step 1‚Äì6/6.1)

Kompletnƒõ dokonƒçena responzivn√≠ varianta DataTableV2 (Hybrid) + zapojen√≠ do TeamPageV2.

### üîπ Step 1/6 ‚Äî API pro card fields
- P≈ôid√°na module augmentation `columnDef.meta.stbMobile` pro TanStack Table.
- Typy: `isTitle`, `isSubtitle`, `priority`, `mobileHidden`, `formatter`.
- ≈Ω√°dn√° zmƒõna UI (jen p≈ô√≠prava).

### üîπ Step 2/6 ‚Äî `<md` Stacked cards (MVP)
- Nov√° komponenta `<DataRowCard />` pro mobiln√≠ layout.
- Title + Subtitle + 3‚Äì5 detail≈Ø, akce vpravo.
- ‚ÄúZobrazit v√≠ce‚Äù pro rozbalen√≠ dal≈°√≠ch pol√≠.

### üîπ Step 3/6 ‚Äî `md‚Äìlg` scrollable + sticky
- Tabulka na st≈ôedn√≠ch breakpointech scrollovateln√° (`overflow-x-auto`).
- Sticky vlevo = Title, sticky vpravo = Akce.
- ‚â•lg: pln√° tabulka, beze zmƒõny.

### üîπ Step 4/6 ‚Äî Polishing & A11y
- P≈ôid√°ny `aria-labelledby`, `aria-controls`, focus ringy, role="list/listitem".
- `motion-safe:animate-pulse` skeletony, `break-words` pro dlouh√© texty.
- Pager propojen s tabulkou (`aria-controls`).

### üîπ Step 5/6 ‚Äî Dokumentace & usage guidelines
- Vytvo≈ôen `README.md` pro DataTableV2.
- Pops√°ny breakpoints, metadata, props, p≈ô√≠klady pou≈æit√≠.
- Sekce A11y + doporuƒçen√≠ pro v√Ωvoj√°≈ôe.

### üîπ Step 6/6 ‚Äî Kontrola konzistence (stavbau-ui)
- P≈ôid√°n `tokens.ts` pro designov√© utility (`sbCardBase`, `sbDivider`, `sbFocusRing`).
- DataRowCard + DataTableV2 p≈ôepnuty na tyto utility.
- Sjednocen radius, spacing, hover, focus a barvy s ostatn√≠mi komponentami.

### üîπ Step 6/6.1 ‚Äî TeamPage wired up
- `TeamPageV2` aktualizov√°na na vyu≈æit√≠ `stbMobile`.
- Mobiln√≠ karty: Title = jm√©no, Subtitle = e-mail, detaily = role + telefon.
- Avatar na mobilu skryt (`mobileHidden: true`).
- Desktop/st≈ôedn√≠ breakpoints beze zmƒõny.

---

‚úÖ DataTableV2 je nyn√≠ plnƒõ responzivn√≠, konzistentn√≠ s `stavbau-ui` a nasazen√° v TeamPageV2.

### ‚úÖ 2025-09-25 ‚Äî TeamPageV2 ‚Äì i18nNamespaces wired
- Do `TeamPageV2` doplnƒõn prop `i18nNamespaces={['team','common']}` pro `DataTableV2`.
- P≈ôeklady mobiln√≠ch karet (labely + hodnoty) nyn√≠ pou≈æ√≠vaj√≠ spr√°vn√Ω namespace str√°nky.
- Varianta p≈ôipraven√° i pro dal≈°√≠ moduly (`invoices`, `files`, `den√≠k`‚Ä¶), kde staƒç√≠ p≈ôedat odpov√≠daj√≠c√≠ namespaces.

### ‚úÖ 2025-09-26 ‚Äî DataTableV2 ‚Äì Responsive & Enterprise UX
- Dokonƒçen pln√Ω **responsive hybrid re≈æim**:
    - `<md` ‚Üí karty (stacked, s p≈ôelo≈æen√Ωmi labely a actions kapsl√≠).
    - `md‚Äìlg` ‚Üí tabulka se str√°nkov√°n√≠m + filtrov√°n√≠m (bez hustoty).
    - `lg+` ‚Üí pln√° tabulka s hustotou, sticky headerem a enterprise vzhledem.
- P≈ôid√°ny `i18nNamespaces` ‚Üí p≈ôeklady label≈Ø a hodnot v kart√°ch funguj√≠ modul√°rnƒõ (Team, Invoices, Files, ‚Ä¶).
- Toolbar: mobile-first p≈ô√≠stup (search + reset na mobilech, ostatn√≠ jen od `md`).
- Sticky header od `lg+`, blur background ‚Üí lep≈°√≠ ƒçitelnost p≈ôi scrollu.
- `densityClasses` refaktorovan√©: mobile-first, od `lg` kompaktnƒõj≈°√≠ (v√≠ce ≈ô√°dk≈Ø na obrazovku).
- Max-width container (`sbContainer`) pro `md+` ‚Üí obsah vycentrovan√Ω, na 1440/2560 nep≈Øsob√≠ roztahanƒõ.
- Mobile ergonomie:
    - men≈°√≠ padding (`p-3` na `<sm`).
    - labely men≈°√≠ (`text-xs`).
    - akƒçn√≠ tlaƒç√≠tka sjednocena do kapsle + min. tap target `36√ó36`.

---

### üîÆ FUTURE (mo≈æn√© vylep≈°en√≠ DataTableV2)
- **Column pinning / freeze** (sticky prvn√≠ sloupec p≈ôi horizont√°ln√≠m scrollu).
- **Row expansion** (detail ≈ô√°dku rozkliknuteln√Ω p≈ô√≠mo v tabulce).
- **Inline edit** pro vybran√© sloupce.
- **Persistent user prefs** ‚Äì ulo≈æit v√Ωbƒõr sloupc≈Ø, hustotu, velikost str√°nky do localStorage / profilu.
- **Virtualizace** (pro tis√≠ce z√°znam≈Ø ‚Üí v√Ωkon).
- **Skeleton loaders** ‚Äì propracovanƒõj≈°√≠ placeholdery, kter√© kop√≠ruj√≠ strukturu sloupc≈Ø.
- **A11y enhancements** ‚Äì nap≈ô. voiceover-friendly labely u action buttons (u≈æ ƒç√°steƒçnƒõ hotovo).
- **Dark mode tuning** ‚Äì jemn√© kontrasty u border≈Ø, muted background.


## [2025-09-26] Zaveden√≠ Customer (invoices)
- ROZHODNUTO: Customer = samostatn√° dom√©na v `invoices` (ne Member), dƒõd√≠ z BaseEntity, company-scoped.
- RBAC: invoices:read|create|update|delete na CustomersController.
- Faktury: FK `customer_id` + snapshot √∫daj≈Ø odbƒõratele v Invoice.
- API: /api/v1/customers (list/search, create, get, patch, delete).

TODO (MVP):
- Vxx__invoices_customers.sql (+ FK v invoices).
- Model/DTO/Mapper/Repo/Service/Web + testy.
- Napojen√≠ snapshotu v InvoiceService, OpenAPI tag.

FUTURE:
- CRM-lite ‚Äûpartners‚Äú (kontakt. osoby, tagy), onboarding klienta (linkedUserId + ProjectMember role=CLIENT).
- ARES prefill z√°kazn√≠k≈Ø.

## [2025-09-26] Customer skeleton (invoices)
HOTOVO: Entity, Repo, DTO, Mapper, Service(+Impl), Controller s RBAC a PageResponse, bez UI.
TODO: Specifikace pro fulltext (Specifications), validaƒçn√≠ i18n messages, integraƒçn√≠ test create‚Üíinvoice snapshot.
FUTURE: Soft delete; CRM-lite (contacts, tags); ARES prefill; client portal (linkedUserId).

## [2025-09-26] Customers & RBAC ‚Äì stav po integraci

### HOTOVO
- **DB migrace (Invoices/Customers)**
    - Tabulka `customers` (company-scoped), indexy (`company_id`, `ico`) a bezpeƒçn√Ω **fulltext index** na `name`:
        - prim√°rnƒõ `GIN (gin_trgm_ops)` p≈ôi dostupn√©m **pg_trgm**,
        - fallback `btree(lower(name))` bez roz≈°√≠≈ôen√≠.
    - `invoices` roz≈°√≠≈ôeno o `customer_id` (FK ‚Üí `customers`, **ON DELETE SET NULL**) a **snapshot** pole `buyer_*` (name/ico/dic/email/address).
    - Opraveno p≈ôid√°n√≠ FK (PostgreSQL neum√≠ `ADD CONSTRAINT IF NOT EXISTS` ‚Üí **DO $$** guard).
- **Common**
    - `BaseEntity` ji≈æ pou≈æ√≠van√°; doplnƒõn **`CompanyScoped` (interface)** s `getCompanyId()/setCompanyId()`.
    - P≈ôid√°n univerz√°ln√≠ **`PageResponse<T>`** (Page wrapper pro REST).
- **Invoices / Customers ‚Äì BE skeleton**
    - `Customer` **extends `BaseEntity` implements `CompanyScoped`**.
    - Repository (`CustomerRepository`), DTO (`CustomerDto`, `CustomerSummaryDto`, `Create*/Update*`), MapStruct `CustomerMapper`.
    - Service + Impl (`CustomerService*`) s **tenancy guardem** a z√°kladn√≠m fulltextem.
    - Controller `CustomersController`:
        - endpointy **/api/v1/customers**: list, get, create(201), patch, delete(204),
        - **RBAC**: zat√≠m `INVOICES_*` (+ meta `INVOICES_WRITE`),
        - **OpenAPI**: `@Operation`, `@ApiResponses`, **tag `Customers`** (oddƒõlenƒõ od Invoices).
- **RBAC ‚Äì Scopes & Roles**
    - Roz≈°√≠≈ôen√Ω **katalog scopes** pro fakturaci (invoices, customers, lines, series, payments, dunning, settings, integration, VAT, reports, templates, webhooks, e-invoicing).
    - **Payments**: doplnƒõn meta-scope `payments:write` + agregace.
    - **BuiltInRoles**: smyslupln√© agregace pro v≈°echny `CompanyRoleName` (OWNER, COMPANY_ADMIN, ACCOUNTANT, ‚Ä¶).
    - Fix: `HR_MANAGER_BASE` ‚Äì `ADMIN_USERS_READ` zabalen do `of(...)` (typov√° korekce).
- **Aplikace startuje** (migrace OK: pg_trgm fallback + DO $$ guardy).

---

### TODO (MVP ‚Äì dal≈°√≠ PRy)
- **Testy**
    - `@DataJpaTest` pro `CustomerRepository` (tenancy + fulltext).
    - `@WebMvcTest` pro `CustomersController` (200/201/204, 401/403/404/409).
    - `@SpringBootTest` integraƒçn√≠: `createInvoice(customerId)` ‚Üí zapisuje snapshot `buyer_*` a dr≈æ√≠ `customer_id`.
- **InvoiceService**
    - Implementovat vytvo≈ôen√≠ faktury z `customerId` (prefill + snapshot), validace existence v r√°mci `companyId`.
- **Vyhled√°v√°n√≠**
    - P≈ôidat `Specification` (name/ico/dic) s `lower(...)` kompatibiln√≠ s obƒõma indexy (trgm/btree).
- **Validace & i18n**
    - IƒåO/DIƒå valid√°tory; i18n kl√≠ƒçe (`customer.*`, konflikty typu `ico.exists`).
- **RBAC anotace & FE toggly**
    - Nechat Customers zat√≠m na `INVOICES_*`; p≈ôipravit p≈ôepnut√≠ na `CUSTOMERS_*` (bez zmƒõny FE).
    - FE: p≈ôidat toggly pro nov√© scopy (payments, series, dunning‚Ä¶).
- **OpenAPI**
    - Zkontrolovat n√°zev security sch√©matu (default `bearerAuth`); p≈ôidat p≈ô√≠klady odpovƒõd√≠ u list/detail.

---

### FUTURE (beze zlom≈Ø ve≈ôejn√©ho API)
- **Split Customers ‚Üí `customers:*`** v kontrolerech (granul√°rnƒõj≈°√≠ ≈ô√≠zen√≠), BE u≈æ p≈ôipraveno.
- **CRM-lite ‚Äûpartners‚Äú**: roz≈°√≠≈ôen√≠ Customers (kontaktn√≠ osoby, v√≠ce adres, tagy); zachovat `Invoice.customerId`.
- **Klientsk√Ω port√°l**
    - Endpoint `POST /customers/{id}/link-user/{userId}` (role `CLIENT` jako `ProjectMember`).
- **Import/Export & Suggest**
    - `POST /customers/import` (CSV/XLSX/JSON), `GET /customers/export`, `GET /customers/suggest?q=`.
- **Soft delete** pro Customers (auditori, historie), politiky koliz√≠ s FK.
- **ARES/VIES**: prefill/ovƒõ≈ôen√≠ IƒåO/DIƒå.
- **Finance PRO**
    - Proformy, dobropisy, **recurring**, n√°kupn√≠ faktury, cen√≠ky/katalog, bankovn√≠ v√Ωpisy & p√°rov√°n√≠,
    - e-invoicing (ISDOC/Peppol), platebn√≠ br√°ny, VAT reporty, reporting.

---

### PR/Repo pozn√°mky
- Dodr≈æet **small PRs (~200 LOC)**, Conventional Commits.
- Po ka≈æd√©m PR: aktualizovat tento soubor (sekce HOTOVO/TODO), `CHANGELOG.md`, ≈°t√≠tky a sprint odkaz.


## [2025-09-27] [MVP] Customers ‚Äì PR 1/6 (FE)
**HOTOVO**
- Z√°klad modulu Customers (list): route `/app/customers`, debounced search (`q`), str√°nkov√°n√≠ (`page`,`size`), RBAC guard (`invoices:read`).
- API klient: `listCustomers`, `getCustomer`; DTO typy vƒçetnƒõ `PageResponse`.

**TODO (dal≈°√≠ PR)**
- Detail drawer + `getCustomer` napojen√≠ (PR 2/6).
- Create/Edit form (RHF+Zod), validace IƒåO/DIƒå (PR 3/6).
- Delete flow s potvrzen√≠m (PR 4/6).
- i18n roz≈°√≠≈ôen√≠ + RBAC toggly pro akce (PR 5/6).
- Testy (unit/RTL/E2E) + contract check PageResponse (PR 6/6).

**FUTURE**
- Server-side sorting & advanced filtry.
- Import/Export, napojen√≠ na ARES suggest.
- P≈ôepnut√≠ scopes z `invoices:*` na `customers:*` pouhou zmƒõnou mapy.

## [2025-09-27] [MVP] Customers ‚Äì PR 2/6 (FE)
**HOTOVO**
- Detail z√°kazn√≠ka jako inline drawer nad listem.
- Deep-link routa `/app/customers/:id` (sd√≠l√≠ str√°nku listu kv≈Øli kontextu).
- `getCustomer()` + `CustomerDto`, mapov√°n√≠ chyb (RFC7807), RBAC READ guard.

**TODO (dal≈°√≠ PR)**
- Create/Edit `CustomerForm` + validace IƒåO/DIƒå (PR 3/6).
- Delete flow s potvrzen√≠m (PR 4/6).
- i18n doplnƒõn√≠ text≈Ø a RBAC toggly pro akce (PR 5/6).
- Testy (unit/RTL/E2E) + contract check (PR 6/6).

**FUTURE**
- Server-side sorting + dal≈°√≠ filtry (mƒõsto, IƒåO).
- Import/Export, ARES suggest, LinkUser.
- P≈ôepnut√≠ z `invoices:*` na `customers:*` jen √∫pravou mapy.

## [2025-09-27] [MVP] Customers ‚Äì PR 3/6 (FE)
**HOTOVO**
- CustomerForm (RHF+Zod) s validac√≠ IƒåO/DIƒå (CZ).
- CustomerFormDrawer pro create/edit, napojen√≠ na API (POST/PATCH).
- ‚ÄûNov√Ω‚Äú na listu s RBAC CREATE, route `/app/customers/new`.

**TODO (dal≈°√≠ PR)**
- Delete flow + potvrzen√≠ (PR 4/6).
- i18n doplnƒõn√≠ tooltip≈Ø pro RBAC toggly + disable stavy (PR 5/6).
- Testy (unit: valid√°tory, form; RTL: render & submit; E2E: create‚Üíedit) (PR 6/6).

**FUTURE**
- Validace DIƒå pro dal≈°√≠ st√°ty (EU VAT).
- ARES suggest/autofill, Import/Export.

## ‚úÖ HOTOVO ‚Äî 2025-09-27 ‚Äî PR#1 FE+BE Address/Contact unifikace (MVP)
- P≈ôid√°n kanonick√Ω `Address` (common/domain), `AddressDto` (common/api/dto),
  `AddressMapper` (common/mapping) a `AddressJsonConverter` (common/persistence).
- Unit test: round-trip JSON ‚Üí objekt ‚Üí JSON (AddressJsonConverterTest).
- ≈Ω√°dn√© zmƒõny existuj√≠c√≠ch entit, ≈æ√°dn√° DB migrace.

### üîú TODO (PR#2)
- Refactor Customers: nahradit `billingAddressJson:String` ‚Üí `Address` (JSONB) v entitƒõ,
  DTO a mapper + migraƒçn√≠ skript (pokud bude t≈ôeba p≈ôevod legacy dat).
- Dopl≈àkov√© testy: @DataJpaTest se skuteƒçn√Ωm JSONB sloupcem (Testcontainers).

### üí° FUTURE
- Normalizaƒçn√≠ helper (nap≈ô. form√°tov√°n√≠ `formatted`, PSƒå, house/orientation merge).
- Integrace s Geo (Mapy.cz) a ARES mappery do `Address`.
- Lokalizaƒçn√≠ labely typ≈Ø adres (fakturace/dod√°n√≠) pro moduly Invoices/Customers.

## ‚úÖ HOTOVO ‚Äî 2025-09-27 ‚Äî PR#2 Customers ‚Üí Address JSONB (typed)
- Customer: p≈ôid√°n `billing_address` (JSONB) + mapov√°n√≠ na `Address`.
- DTO: `billingAddress` (AddressDto) + ponech√°n deprecated `billingAddressJson` pro p≈ôechod FE.
- Migrace: p≈ôid√°n sloupec a best-effort naplnƒõn√≠ z legacy textu (bez dropu).
- Test: @DataJpaTest ‚Äì round-trip JSONB.
- Removed entity legacy field; legacy JSON emulated in DTO mapping

### üîú TODO (PR#3)
- Odstranƒõn√≠ `billingAddressJson` (sloupec + DTO) po √∫pravƒõ FE.
- Dopl≈àkov√© validaƒçn√≠/normalizaƒçn√≠ helpery pro Address (PSƒå, formatted).
- Integraƒçn√≠ testy s REST (WebMvcTest) + contract test FE/BE.

### üí° FUTURE
- Unified ‚Äûaddress kind‚Äú (billing/shipping/registered) + labely (i18n).
- Reuse Address pro dal≈°√≠ moduly (Projects sites, Company registered address).

### ‚úÖ 2025-10-01 ‚Äì üü¢ Modul Team ‚Äì Skeleton + FE/BE integrace

## ‚úÖ HOTOVO
- FE skeleton modulu **Team**:
    - `api/client.ts` ‚Äì CRUD funkce + `updateMemberProfile`, `updateMemberRole`, `getMembersStats`
    - `api/types.ts` ‚Äì sjednocen√© DTO (`MemberDto`, `MemberSummaryDto`, `MembersStatsDto`, requesty)
    - `components/TeamTable.tsx` ‚Äì integrace s `DataTableV2`, RBAC row actions
    - `components/TeamForm.tsx` ‚Äì validace p≈ôes Zod sch√©mata, props `lockCompanyRole`, `lockReasonKey`
    - `components/TeamFormDrawer.tsx` ‚Äì naƒç√≠t√°n√≠ detailu (`getMember`), integrace `useMembersStats`, `safeOnSubmit` s kontrolou posledn√≠ho OWNERa
    - `components/TeamDetailDrawer.tsx` ‚Äì profesion√°ln√≠ preview ƒçlena (p≈ôipraveno na roz≈°√≠≈ôen√≠ o avatar, adresy)
    - `pages/TeamPage.tsx` ‚Äì integrace v≈°ech ƒç√°st√≠ (list, create, edit, detail), FAB, empty states, i18n
    - `validation/schemas.ts` ‚Äì `MemberSchema`, typ `AnyTeamFormValues`
- Vytvo≈ôen hook `useMembersStats` ‚Äì naƒç√≠t√° data z BE endpointu (poƒçty ƒçlen≈Ø, validace posledn√≠ho OWNERa).
- Vytvo≈ôen **prompt** pro BE endpoint `GET /tenants/{companyId}/members/stats` (DTO + n√°vrh implementace).
- UI kit: roz≈°√≠≈ôen√Ω `Button` (varianty `xs`, `fab`, decentn√≠ destructive variant).
- Upraveny empty/error/loading stavy v `TeamPage` ‚Üí pou≈æ√≠vaj√≠ stavbau-ui a i18n.
- Refaktoring `TeamForm` a `TeamFormDrawer` ‚Äì podpora uzamƒçen√≠ zmƒõny role, hl√°≈°ky p≈ôes i18n.

## üü° TODO
- FE:
    - Roz≈°√≠≈ôit `TeamDetailDrawer` o profilov√Ω obr√°zek, trvalou a doruƒçovac√≠ adresu.
    - Doplnit unit/integration testy pro `TeamTable`, `TeamForm`, `useMembersStats`.
    - P≈ôidat contract testy pro `getMembersStats` (mock server).
- BE:
    - Implementovat endpoint `GET /api/v1/tenants/{companyId}/members/stats` dle p≈ôipraven√©ho promptu.
    - Pokr√Ωt integraƒçn√≠mi testy (poƒçty owner≈Ø, invited, disabled, total).
- Governance:
    - Vytvo≈ôit PR: `feat(team): add members stats endpoint`.
    - Po nasazen√≠ aktualizovat i18n kl√≠ƒçe (`errors.lastOwner`, `detail.*`).
- UX:
    - Vylep≈°it FAB a row actions pro mobiln√≠ zobrazen√≠.
    - P≈ôidat toast/notifikace po √∫spƒõ≈°n√©m create/edit/delete ƒçlena.

## üïí FUTURE
- Integrovat adresy (Registered + Delivery) do profilu ƒçlena (FE + BE).
- Podpora avatar≈Ø p≈ôes file upload (profile picture).
- Statistiky v dashboardu firmy (poƒçty aktivn√≠ch ƒçlen≈Ø, invited apod. na hlavn√≠ str√°nce).
- Konsolidace validace mezi FE a BE (Zod ‚Üî Bean Validation).
- Hotov√Ω z√°klad pro dal≈°√≠ roz≈°i≈ôov√°n√≠ profilu (CompanyMember) ƒçlena (adresy, avatar).

### ‚úÖ 2025-10-01 ‚Äì BE: Members stats endpoint (Team)
- P≈ôid√°n endpoint `GET /api/v1/tenants/{companyId}/members/stats`
- RBAC: vy≈æaduje `team:read`
- Vrac√≠: `{ owners, active, invited, disabled, total }` (company-scoped)
- Implementace: DTO + repo agregace (COUNT/CASE) + service + controller
- Testy: WebMvcTest (403/200), DataJpaTest (agregace)

**TODO (next):**
- Validovat/zarovnat `status` pole v `CompanyMember` (ACTIVE/INVITED/DISABLED) ‚Äì sjednotit enum.
- (Volit.) cache kr√°tk√Ωm TTL (Caffeine) pro velk√© firmy.
- (Volit.) roz≈°√≠≈ôit o dal≈°√≠ metriky (nap≈ô. poƒçet podle projektov√© role).

**FUTURE:**
- Admin n√°hled: stats nap≈ô√≠ƒç v√≠ce firmami (jen pro SUPERADMIN).

### üïí Miln√≠k ‚Äì 2025-10-01
Dokonƒçen skeleton FE modulu **Team** (list, detail, form, drawery, RBAC, validace, i18n, hook `useMembersStats`).  
P≈ôipraven prompt pro BE endpoint `GET /members/stats`.  
Hotov√Ω z√°klad pro dal≈°√≠ roz≈°i≈ôov√°n√≠ profilu ƒçlena (adresy, avatar).  

## üïí Miln√≠k 2025-10-03

### Hotovo
- Upraven `TeamForm` tak, aby podporoval `resetAfterSubmit` (v√Ωchoz√≠ true pro `create`, false pro `edit`).
- P≈ôid√°n `key` na komponentu `TeamForm` (`${mode}-${memberId}`) ‚Üí spr√°vn√Ω remount p≈ôi zmƒõnƒõ m√≥du nebo ƒçlena.
- Doplnƒõn cleanup `prefill` p≈ôi zav≈ôen√≠ `TeamFormDrawer` ‚Üí ≈æ√°dn√° star√° data p≈ôi znovuotev≈ôen√≠.
- O≈°et≈ôen lok√°ln√≠ error nad formul√°≈ôem a sjednoceno chov√°n√≠ p≈ôi submitu.
- Formul√°≈ô se nyn√≠ korektnƒõ resetuje po √∫spƒõ≈°n√©m vytvo≈ôen√≠ ƒçlena (create), zat√≠mco v editu zachov√°v√° hodnoty.

### TODO
- Roz≈°√≠≈ôit validace (nap≈ô. phone pattern, voliteln√© dal≈°√≠ pole).
- P≈ôidat loading stavy do submit tlaƒç√≠tka (`isLoading`) v `TeamForm`.
- Otestovat v√≠ce edge-case sc√©n√°≈ô≈Ø (cancel bƒõhem editace, zav≈ôen√≠ ≈°upl√≠ku p≈ôi pending submit).

### Future
- P≈ôipravit jednotnou logiku pro validaci unik√°tnosti emailu u≈æ na FE (nap≈ô. async validator).
- Roz≈°√≠≈ôit `TeamForm` o adresy (permanentn√≠/doruƒçovac√≠) a≈æ BE endpoint bude p≈ôipraven.

### ‚úÖ 2025-10-02 ‚Äì BE:  PR 1/4 ‚Äì Projects: DB & model (MVP)
- P≈ôid√°ny tabulky: `projects`, `project_translations`, `project_members` (Flyway).
- Vytvo≈ôeny entity: Project, ProjectTranslation, ProjectMember (+ repo vrstvy).
- P≈ôid√°n enum ProjectRoleName (PROJECT_MANAGER, SITE_MANAGER, QUANTITY_SURVEYOR, MEMBER, VIEWER).
- Dodr≈æena modularita by-feature, i18n translation table, p≈ôipraveno na RBAC 2.1 projektov√© role.
- Bez zmƒõn API (service/REST nav√°≈æe v PR 2/4 a 3/4).

### ‚ñ∂ TODO next
- PR 2/4: `ProjectService` + MapStruct mapper (DTO, i18n fallback, tenancy guard).
- PR 3/4: `ProjectController` + RBAC anotace (`projects:read|create|update|delete|assign`).
- PR 4/4: FE skeleton (list + create) s DataTableV2.

### ‚úÖ 2025-10-02 ‚Äì BE: PR 2/4 ‚Äì doplnƒõn i18n stack (LocaleResolver)
- P≈ôid√°n LocaleResolver + LocaleContext (request-scoped), MessageService, EnumLabeler.
- Konfigurace: MessageSourceConfig, WebConfig (interceptor pro nastaven√≠ locale).
- SecurityUtils: helper currentUserLocale().
- Projects service nyn√≠ ≈ôe≈°√≠ fallback ≈ôetƒõzec: ?lang ‚Üí Accept-Language ‚Üí user ‚Üí company ‚Üí app default.

### ‚ñ∂ TODO next
- PR 3/4: ProjectController + @PreAuthorize + PageResponse + hlaviƒçky `Content-Language` a `Vary: Accept-Language`.
- P≈ôidat EnumLabeler pro `statusLabel` (Projects).
- Roz≈°√≠≈ôit list o fulltext p≈ôes `project_translations` (per-locale).

### ‚úÖ 2025-10-03 ‚Äì BE: PR 2b/4 ‚Äì Company defaults (locale)
- DB: p≈ôid√°n sloupec `companies.default_locale` + CHECK regex; seed na `cs-CZ`.
- BE: `Company.defaultLocale` s @Pattern; repo metoda pro ƒçten√≠.
- Service: `CompanyLocaleService` + impl; LocaleResolver pou≈æ√≠v√° firemn√≠ fallback.

### ‚ñ∂ TODO next
- UI: nastaven√≠ jazyka firmy (select `cs-CZ`/`en`‚Ä¶), validace BCP-47.
- (voliteln√©) Company defaults roz≈°√≠≈ôit o `defaultCurrency`, `vatMode` (budouc√≠ moduly).

### ‚úÖ 2025-10-03 ‚Äì BE:  PR 3/4 ‚Äì Projects: REST + RBAC + i18n headers (rozpracovat)
- Controller: /api/v1/projects (list/get/create/update/delete).
- P≈ôid√°n `/api/v1/projects/{id}/archive` (soft delete).
- Stubs: `POST /{id}/members`, `DELETE /{id}/members/{userId}` (zat√≠m 202/204).
- RBAC: @PreAuthorize s 'projects:*'.
- I18n: Content-Language + Vary: Accept-Language.
- Swagger: tag "Projects".

### ‚ñ∂ TODO next
- Implementovat service metody: `assignMember`, `removeMember`.
- Roz≈°√≠≈ôit list o filtry `status`, `archived`.
- @WebMvcTest testy na RBAC a i18n hlaviƒçky.

